---
title: "ISME_script"
author: "Charlotte PAES"
date: "9 avril 2020"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(phyloseq)
library(car)
library(DESeq2)
library(corrplot)
library(MASS)
library(CCA)
library(RColorBrewer)
library(vegan)
library(nlme)
library(lme4)
library(lmerTest)
library(lsmeans)
library(multcomp)
library(agricolae)
library(dplyr)
library(tidyr)
library(threejs)
library(DT)
library(phyloseq)
library(mixOmics)
library(psych)
library(mise)
library(igraph)
library(phyloseq)
library(ape)
library(made4)
library(plotly)
library(stringr)
library(usedist)
library(ggdendro)
library(labdsv)
library(ggplot2)
library(scatterplot3d)
library(tibble)
library(Hmisc)
library(Rmisc) 
library(readxl)
library(multcomp)
library(gridExtra)
source(file="P:/Experimentation/CP1703prebio/script/reportlm.r") 
source(file="P:/Experimentation/CP1703prebio/script/report_lme.r") 

setwd("C:/Users/cpaes/Documents/Scientific_data")
```

#Ingestion pattern

##Milk consumption
###Import and cleaning
```{r cleaning data, warning=FALSE}
MILK<-read.table("Milk_consumption.csv", header=TRUE, sep=";", dec=",")
MILK$GROUP<-as.factor(MILK$GROUP)
MILK$MILK_CONSUMED_RABBIT<-as.numeric(as.character(MILK$MILK_CONSUMED_RABBIT))

#We delete negative values
MILK<-MILK[MILK[,8]>0,]

#We look for outliers
boxplot(MILK_CONSUMED_RABBIT~AGE, data=MILK)
SEmilk<-summarySE(MILK, measurevar="MILK_CONSUMED_RABBIT", groupvars=c("AGE"), na.rm=TRUE)
#outliers are considered with the rule mean+/-3*sd because partial suckling could have occured

#threshold inf day 7
b7<-SEmilk[2,3]-3*SEmilk[2,4]

#threshold inf day 10
b10<-SEmilk[3,3]-3*SEmilk[3,4]

#threshold inf day 14
b14<-SEmilk[4,3]-3*SEmilk[4,4]

#threshold inf day 17
b17<-SEmilk[5,3]-3*SEmilk[5,4]

#thresholds day 21
b21n<-SEmilk[6,3]-3*SEmilk[6,4]
b21p<-SEmilk[6,3]+3*SEmilk[6,4]

#outliers considered as missing data
for (k in 1:nrow(MILK)) {
  if ((MILK[k,10]=="7") & (MILK[k,8]<b7)){
    MILK[k,8]<-"NA"
  }
}

for (k in 1:nrow(MILK)) {
  if ((MILK[k,10]=="10") & (MILK[k,8]<b10)){
    MILK[k,8]<-"NA"
  }
}
for (k in 1:nrow(MILK)) {
  if ((MILK[k,10]=="17") & (MILK[k,8]<b17)){
    MILK[k,8]<-"NA"
  }
}
for (k in 1:nrow(MILK)) {
  if ((MILK[k,10]=="21") & (MILK[k,8]<b21n)){
    MILK[k,8]<-"NA"
  }
}
for (k in 1:nrow(MILK)) {
  if ((MILK[k,10]=="21") & (MILK[k,8]>b21p)){
    MILK[k,8]<-"NA"
  }
}

MILK$MILK_CONSUMED_RABBIT<-as.numeric(as.character(MILK$MILK_CONSUMED_RABBIT))
boxplot(MILK_CONSUMED_RABBIT~AGE, data=MILK)
# 
# pd <- position_dodge(0.2)
# col<-c("#FFCC00", "#FF6600", "#006600")
# SEmilk<-summarySE(MILK, measurevar="MILK_CONSUMED_RABBIT", groupvars=c("AGE", "GROUP"), na.rm=TRUE)
# SEmilk<-subset(SEmilk, GROUP!="COM")
# ggplot(SEmilk, aes(x=AGE, y=MILK_CONSUMED_RABBIT), group=GROUP) + geom_line(aes(group = GROUP, color = GROUP), size = 1)+ geom_point(aes(group = GROUP, color = GROUP), size=1.5) + geom_errorbar(aes(ymin=MILK_CONSUMED_RABBIT-se, ymax=MILK_CONSUMED_RABBIT+se, colour=GROUP), width=.3,
#                  position=position_dodge(.2)) + scale_x_continuous(name="Age (jours)") + scale_y_continuous(name="Milk intake \n (g of fresh matter/rabbit)") + scale_color_manual(values=col, name="Groups", labels=c("STA-", "STA+", "FF+")) + theme_classic()+theme(legend.position="right",axis.line=element_line(size = 1, color = "black"), 
#                                            axis.ticks.length = unit(.2, "cm"), 
#                                            axis.text = element_text( size = 12, color = "black"), 
#                                            axis.title = element_text(face="bold", size = 15, color = "black"), 
#                                            legend.text = element_text( size = 12), 
#                                            legend.title = element_text(face="bold", size = 15), legend.key.height = unit(.7, "cm")) #permet d'enlever légende pour couleur 
# 
# boxpGROUP(MILK_CONSUMED_RABBIT~AGE, data=MILK, ylab="Ingestion de milk journalière (en g de MF/lapin)", xlab="Age lapereau")
```

###Statistics
```{r Test of milk ingestion difference between groups}
mod_milk=lme(MILK_CONSUMED_RABBIT~GROUP*AGE, random=~1|FEMALE, data=MILK, na.action=na.omit)
mod_milkc<-update(mod_milk,weights=varIdent(form=~1|AGE), method="ML")
plot(mod_milkc, resid(., type = "p") ~fitted(.), abline = 0) #mieux 
anova(mod_milkc) #juste effet jours
synth_MILK<-summary(MILK_CONSUMED_RABBIT~GROUP*AGE, method="cross", fun=smean.sd, data=MILK)
datatable(synth_MILK, colnames=c("Group","Age", "Milk consumed (g/rabbit)", "N portees", "NA")) %>% formatRound(columns=c('GROUP', 'AGE', 'S', 'N', 'Missing'), digits=1)
```

#Microbiota analysis
In total : 296 samples from 10 rabbits per age and per group (ages: 18, 25, 30, 38 and 58 days of age; groups: STA-/STA+/RFF+) with two areas investigated (caecum body and appendix vermiformis). 
Include 147 samples from appendix vermiformis and 149 from the caecum body

```{r Import}
options(scipen=999)
options(contrasts = c("contr.sum", "contr.poly"))

load("P:/Experimentation/Physiologie/DATA FROGS/Tri_AMI_FRF_cc_vv/Galaxy22-appendice_caecum.rdata")
frogs.data<-data
#To change factors
fact<-data.frame(sample_data(frogs.data))
fact$POIDS<-as.numeric(as.character(fact$POIDS))
fact$AGE_LOT<-interaction(fact$AGE2, fact$LOT, sep="_")
fact$AGE_LOT<-factor(fact$AGE_LOT, levels = c("18_AMIN", "25_AMIN", "30_AMIN", "38_AMIN", "58_AMIN", "18_AMIP", "25_AMIP", "30_AMIP", "38_AMIP", "58_AMIP", "18_FRF", "25_FRF", "30_FRF", "38_FRF", "58_FRF"))
fact$AGE2<-as.factor(fact$AGE2)
fact$AGE2<-factor(fact$AGE2, levels=c("18", "25", "30", "38", "58"))
fact$NUMERO_ORGANE<-interaction(fact$NUMERO, fact$ORGANE, sep="_")
fact$AGE2_ORGANE<-interaction(fact$AGE2, fact$ORGANE, sep="_")
#summary(fact)
sample_data(frogs.data)<-(fact)

frogs.dataami<-subset_samples(frogs.data, LOT!="FRF")
#sample_data(frogs.dataami)
frogs.dataprecoce<-subset_samples(frogs.data, LOT!="AMIN")
#sample_data(frogs.dataprecoce)
frogs.data_caecum<-subset_samples(frogs.data, ORGANE=="caecum")
frogs.data_vermiforme<-subset_samples(frogs.data, ORGANE=="vermiforme")
```



#Metabolomics analysis
```{r loading metabolomics data}
metabo<-read_excel("P:/Analyses Martin/CP1802_metabolites_remanié.xlsx", na="NA")
metabo$portee<-as.factor(metabo$portee)
metabo$groupe<-as.factor(as.character(metabo$groupe))
metabo$agegroupe<-as.factor(as.character(metabo$agegroupe))
metabo$age<-as.factor(as.character(metabo$age))
```

##Analysis groups STA-/STA+

```{r}
#Extract groups of interest
metabosansCOM<-subset(metabo, groupe!="COM")
summary(metabosansCOM)
metaboAMI<-subset(metabosansCOM, groupe!="FRF")
summary(metaboAMI)

summary<-metaboAMI%>%dplyr::select(.,butyrate:phenylalanine, groupe, age)%>%dplyr::group_by(groupe, age)%>%dplyr::summarise_all(funs(mean,sd, se=sd(.)/sqrt(n())))
summary[,3:89]<-round(summary[,3:89],1)
datatable(summary)
```

__Linear mixed model loop__
```{r}
#Loop                                                        
lme_result<-list()
ctrl <- lmeControl(opt='optim')
df<-metaboAMI[,c(1:29)]
for (i in 1:29)
{
	newvar<-unlist(metaboAMI[,i])
	lme_result$names[[i]] <- colnames(df)[i]
	mod_REML<-lmerTest::lmer(log10(newvar+1) ~ groupe*age + (1|portee), data =metaboAMI)
	mod_REMLupdate<-update(mod_REML,REML = FALSE)
	plot(residuals(mod_REML))
	lme_result$shap[[i]] <-shapiro.test(residuals(mod_REMLupdate))
  lme_result$pval[[i]]<-car::Anova(mod_REMLupdate, type="III")
} 
reportAGE<-report_lme(lme_result)[,3]
reportLOT<-report_lme(lme_result)[,2]
reportAGE_LOT<-report_lme(lme_result)[,4]
#FDR correction
report_pval_lme <- p.adjust(reportAGE, method="fdr")
report_pval_lme2 <- p.adjust(reportLOT, method="fdr")
report_pval_lme3 <- p.adjust(reportAGE_LOT, method="fdr")

result=data.frame(round(report_pval_lme,3), round(report_pval_lme2,3), round(report_pval_lme3,3))

colnames(result)=c('padj_AGE', 'padj_LOT','padj_AGExLOT')
rownames(result)=colnames(metaboAMI[1:29])
datatable(result)
```

__acetate__
```{r}
mod_acetate<-lmerTest::lmer(log10(acetate+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_acetate)
Anova(mod_acetate, type="III")
lsmeans(mod_acetate,pairwise~groupe|age)
```

__butyrate__
```{r}
mod_butyrate<-lmerTest::lmer(log10(butyrate+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_butyrate)
Anova(mod_butyrate, type="III")
lsmeans(mod_butyrate,pairwise~groupe|age)
```

__threonine__
```{r}
mod_threonine<-lmerTest::lmer(log10(threonine+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_threonine)
Anova(mod_threonine, type="III")
lsmeans(mod_threonine,pairwise~groupe|age)
```

__valine__
```{r}
mod_valine<-lmerTest::lmer(log10(valine+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_valine)
Anova(mod_valine, type="III")
lsmeans(mod_valine,pairwise~groupe|age)
```

__phenylalanine__
```{r}
mod_phenylalanine<-lmerTest::lmer(log10(phenylalanine+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_phenylalanine)
Anova(mod_phenylalanine, type="III")
lsmeans(mod_phenylalanine,pairwise~groupe|age)
```

__lysine__
```{r}
mod_lysine<-lmerTest::lmer(log10(lysine+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_lysine)
Anova(mod_lysine, type="III")
lsmeans(mod_lysine,pairwise~groupe|age)
```

__leucine__
```{r}
mod_leucine<-lmerTest::lmer(log10(leucine+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_leucine)
Anova(mod_leucine, type="III")
lsmeans(mod_leucine,pairwise~groupe|age)
```

__glycine__
```{r}
mod_glycine<-lmerTest::lmer(log10(glycine+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_glycine)
Anova(mod_glycine, type="III")
lsmeans(mod_glycine,pairwise~groupe|age)
```

__glutamate__
```{r}
mod_glutamate<-lmerTest::lmer(log10(glutamate+1) ~ groupe*age + (1|portee), data =metaboAMI)
#plot(mod_glutamate)
Anova(mod_glutamate, type="III")
lsmeans(mod_glutamate,pairwise~groupe|age)
```

__3_methyl_2_oxobutyrate__
```{r}
colnames(metaboAMI)[7]<-"oxobutyrate"
mod_oxobutyrate<-lmerTest::lmer(log10(oxobutyrate+1) ~ groupe*age + (1|portee), data =metaboAMI)
Anova(mod_oxobutyrate, type="III")
#plot(mod_oxobutyrate)
lsmeans(mod_oxobutyrate,pairwise~groupe|age)
```

##Analysis groups STA+/RFF+

```{r}
#Extract groups of interest
metabo_earlyfeed<-subset(metabosansCOM, groupe!="AMI-")
#check : summary(metabo_earlyfeed)

summary<-metabo_earlyfeed%>%dplyr::select(.,butyrate:phenylalanine, groupe, age)%>%dplyr::group_by(groupe, age)%>%summarise_all(funs(mean,sd, se=sd(.)/sqrt(n())))
summary[,3:89]<-round(summary[,3:89],1)
datatable(summary)
```

__Linear mixed model loop__
```{r}
#Loop                                                        
lme_result<-list()
ctrl <- lmeControl(opt='optim')
df<-metabo_earlyfeed[,c(1:29)]
for (i in 1:29)
{
	newvar<-unlist(metabo_earlyfeed[,i])
	lme_result$names[[i]] <- colnames(df)[i]
	mod_REML<-lmerTest::lmer(log10(newvar+1) ~ groupe*age + (1|portee), data =metabo_earlyfeed)
	mod_REMLupdate<-update(mod_REML,REML = FALSE)
	plot(residuals(mod_REML))
	lme_result$shap[[i]] <-shapiro.test(residuals(mod_REMLupdate))
  lme_result$pval[[i]]<-Anova(mod_REMLupdate, type="III")
} 
reportAGE<-report_lme(lme_result)[,3]
reportLOT<-report_lme(lme_result)[,2]
reportAGE_LOT<-report_lme(lme_result)[,4]
#FDR correction
report_pval_lme <- p.adjust(reportAGE, method="fdr")
report_pval_lme2 <- p.adjust(reportLOT, method="fdr")
report_pval_lme3 <- p.adjust(reportAGE_LOT, method="fdr")

result=data.frame(round(report_pval_lme,3), round(report_pval_lme2,3), round(report_pval_lme3,3))

colnames(result)=c('padj_AGE', 'padj_LOT','padj_AGExLOT')
rownames(result)=colnames(metabo_earlyfeed[1:29])
datatable(result)
```

__methanol__
```{r}
mod_methanol<-lmerTest::lmer(log10(methanol+1) ~ groupe*age + (1|portee), data =metabo_earlyfeed)
#plot(mod_methanol)
Anova(mod_methanol, type="III")
lsmeans(mod_methanol,pairwise~groupe|age)
```


__glucose__
```{r}
mod_glucose<-lmerTest::lmer(log10(glucose+1) ~ groupe*age + (1|portee), data =metabo_earlyfeed)
#plot(mod_glucose)
Anova(mod_glucose, type="III")
lsmeans(mod_glucose,pairwise~groupe|age)
```
